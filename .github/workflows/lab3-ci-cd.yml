name: Lab3 CI-CD Speech Commands

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TRAIN_IMAGE: speech-commands-train
  INFER_IMAGE: speech-commands-infer

jobs:
  # 1) ТРЕНУВАННЯ МОДЕЛІ -----------------------
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build training Docker image
        run: docker build -t $TRAIN_IMAGE .

      - name: Train model inside container
        run: |
          mkdir -p saved_model
          docker run --rm \
            -v ${{ github.workspace }}/saved_model:/app/saved_model \
            $TRAIN_IMAGE \
            python train.py | tee train.log

      - name: Upload trained model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: saved_model/model.pth

      - name: Upload training log
        uses: actions/upload-artifact@v4
        with:
          name: training-log
          path: train.log

  # 2) ОЦІНКА (accuracy + latency) -------------
  evaluate:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: saved_model

      - name: Build evaluation Docker image
        run: docker build -t $TRAIN_IMAGE .

      - name: Run evaluation
        run: |
          mkdir -p metrics
          docker run --rm \
            -v ${{ github.workspace }}/saved_model:/app/saved_model \
            $TRAIN_IMAGE \
            python evaluate.py | tee metrics/evaluate.log

      - name: Upload evaluation metrics
        uses: actions/upload-artifact@v4
        with:
          name: eval-metrics
          path: metrics

  # 3) ЗБІРКА INFERENCE-ОБРАЗУ -----------------
  build_inference:
    runs-on: ubuntu-latest
    needs: evaluate

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: saved_model

      - name: Build inference Docker image
        run: docker build -t $INFER_IMAGE .

      - name: Save inference image as tar
        run: |
          mkdir -p artifacts
          docker save $INFER_IMAGE | gzip > artifacts/inference_image.tar.gz

      - name: Upload inference image
        uses: actions/upload-artifact@v4
        with:
          name: inference-image
          path: artifacts/inference_image.tar.gz

  # 4) SMOKE-TEST СЕРВІСУ ----------------------
  smoke_test:
    runs-on: ubuntu-latest
    needs: build_inference

    steps:
      - name: Download inference image
        uses: actions/download-artifact@v4
        with:
          name: inference-image
          path: artifacts

      - name: Load Docker image
        run: docker load -i artifacts/inference_image.tar.gz

      - name: Run container and check HTTP 200
        run: |
          docker run -d --rm -p 5000:5000 --name speech-app $INFER_IMAGE
          sleep 10
          curl --fail http://127.0.0.1:5000/ || (docker logs speech-app && exit 1)
          docker stop speech-app
