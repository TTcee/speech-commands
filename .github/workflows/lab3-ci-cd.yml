name: lab3-ci-cd

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    env:
      TRAIN_IMAGE: speech-commands-train

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build training image
        run: |
          docker build -t $TRAIN_IMAGE .

      - name: Run training (save model)
        shell: bash
        run: |
          mkdir -p saved_model
          docker run --rm \
            -v "${{ github.workspace }}/saved_model:/app/saved_model" \
            $TRAIN_IMAGE \
            bash -c "python train.py | tee /app/saved_model/training.log"

          echo "== Contents of saved_model after training =="
          ls -R saved_model || true

          # якщо модель не збережена – вважаємо це помилкою
          if [ ! -f saved_model/model.pth ]; then
            echo 'ERROR: saved_model/model.pth not found after training' >&2
            exit 1
          fi

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: saved_model/model.pth

      - name: Upload training log
        uses: actions/upload-artifact@v4
        with:
          name: training-log
          path: saved_model/training.log

  evaluate:
    needs: train
    runs-on: ubuntu-latest
    env:
      TRAIN_IMAGE: speech-commands-train

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: saved_model

      - name: Run evaluation in Docker (save metrics)
        shell: bash
        run: |
          mkdir -p metrics
          docker run --rm \
            -v "${{ github.workspace }}/saved_model:/app/saved_model" \
            -v "${{ github.workspace }}/metrics:/app/metrics" \
            $TRAIN_IMAGE \
            bash -c "python evaluate.py | tee /app/metrics/evaluate.log"

      - name: Upload evaluation metrics
        uses: actions/upload-artifact@v4
        with:
          name: eval-metrics
          path: metrics/

  build_inference:
    needs: evaluate
    runs-on: ubuntu-latest
    env:
      INFERENCE_IMAGE: speech-commands-inference

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: saved_model

      - name: Build inference image
        run: |
          docker build -t $INFERENCE_IMAGE .

      - name: Save inference image as artifact
        run: |
          docker save $INFERENCE_IMAGE -o inference-image.tar

      - name: Upload inference image
        uses: actions/upload-artifact@v4
        with:
          name: inference-image
          path: inference-image.tar

  smoke_test:
    needs: build_inference
    runs-on: ubuntu-latest
    env:
      INFERENCE_IMAGE: speech-commands-inference

    steps:
      - name: Download inference image
        uses: actions/download-artifact@v4
        with:
          name: inference-image
          path: .

      - name: Load Docker image
        run: docker load -i inference-image.tar

      - name: Run container and smoke test
        shell: bash
        run: |
          docker run -d -p 5000:5000 --name speech-app $INFERENCE_IMAGE
          # даємо сервісу стартануть
          sleep 15
          # якщо curl повертає помилку – показуємо логи й фейлимося
          curl -f http://localhost:5000/ || (docker logs speech-app && exit 1)
          docker stop speech-app
          docker rm speech-app
